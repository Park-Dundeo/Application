# 청지기 재정 시스템 — 프로젝트 현황

> 최종 업데이트: 2026-02-17

## 프로젝트 개요

개인 가계부 자동화 및 예산 관리 시스템. **청지기적 재정 철학** 기반.
- "맡겨진 것을 하나님의 뜻에 맞게 배분하는 것이 목표"
- 목표 주도 배분 / 연봉 내 설계, 부족 시 구함 / 투명한 추적

---

## 시스템 구성

### 1. OpenClaw Pipeline (완료, 크론잡 운영 중)
뱅크샐러드 → Gmail → 7단계 자동 파이프라인 → Google Sheets

```
ingest → unzip → normalize → dedup → apply → categorize → budget
```

- `app/main.py` — 파이프라인 실행 진입점
- `app/pipeline/` — 각 단계별 모듈
- `data/rules.json` — 900+ 분류 규칙
- `data/categories.json` — 44개 유효 카테고리
- **K열 태깅**이 전체 시스템의 핵심 연결고리

### 2. 예산 관리 (Config-Driven, 구현 완료)

```
계획 영역 (YAML + CLI)          현황 영역 (Google Sheets)
┌─────────────────────┐        ┌──────────────────────┐
│ data/               │        │ 준서의 인생 계획       │
│   budget_config.yaml│──deploy─→│  가계부 내역 (원장)  │
│   (구조의 원본)      │        │  예산안 시트 (5층 뷰) │
└─────────────────────┘        └──────────────────────┘
```

#### 5층 예산 구조 (목적 우선순위)

| 층 | 이름 | 철학 | 월 예산 |
|----|------|------|---------|
| 1층 | 하나님의 몫 | 먼저 드리고 나머지로 산다 | 145K |
| 2층 | 사명 프로젝트 | 목표가 예산을 이끈다 | 870K |
| 3층 | 청지기 운영 | 절약이 아니라 적정 관리 | 2,875K |
| 4층 | 성장 씨앗 | 미래 역량 투자 | 20K (+상여) |
| 5층 | 신뢰 여백 | 모자라면 구한다 | 930K |
| **합계** | | | **4,840K/월 · 58,080K/년** |

#### CLI 명령어

```bash
python3 -m app.pipeline.budget validate   # config 무결성 검증
python3 -m app.pipeline.budget status     # 층별 현황 (오프라인)
python3 -m app.pipeline.budget preview    # XLSX 미리보기
python3 -m app.pipeline.budget deploy     # Google Sheets 생성
python3 -m app.pipeline.budget deploy --force  # 재생성
```

#### 워크플로우 사이클

```
① 계획 (yaml) → ② 배포 (deploy) → ③ 추적 (자동) → ④ 점검 (리뷰) → ⑤ 조정 → ①
```

---

## 핵심 파일 구조

```
Application/
├── app/
│   ├── main.py                  # 파이프라인 진입점
│   ├── config.py                # AppConfig 설정
│   ├── adapters/
│   │   ├── google_auth.py       # OAuth 인증
│   │   ├── sheets.py            # Sheets API 래퍼
│   │   └── llm.py               # LLM 분류 보조
│   ├── pipeline/
│   │   ├── budget.py            # 예산 파이프라인 (config-driven)
│   │   ├── categorize.py        # K열 자동 태깅
│   │   ├── apply_sheet.py       # Sheets 기록
│   │   ├── ingest.py / unzip.py / normalize.py / dedup.py
│   │   └── __init__.py
│   └── utils/
│       ├── rules.py             # 규칙 엔진
│       └── ...
├── data/
│   ├── budget_config.yaml       # ★ 예산 구조 원본
│   ├── rules.json               # 분류 규칙 (900+)
│   ├── categories.json          # 유효 카테고리 (44개)
│   ├── budget_keywords.json     # 키워드 분류
│   └── google_token.json        # OAuth 토큰
├── accountbook_analysis/
│   ├── analysis.md              # ← 이 파일
│   ├── steward_finance_philosophy.md    # 철학 문서
│   ├── steward_finance_architecture.drawio  # 아키텍처 다이어그램 (3페이지)
│   ├── spreadsheet_structure.md         # 기존 시트 구조 분석
│   ├── new_budget_proposal.md           # 실적 기반 예산안 제안
│   └── new_budget_sheet.py              # (구버전, budget.py로 대체됨)
└── sample/
    └── 준서의 인생 계획.xlsx    # 원본 스프레드시트 (14시트)
```

---

## 핵심 연결고리: K열 (상세)

```
가계부 내역 K열 값  ←→  budget_config.yaml의 item.key  ←→  예산안 SUMIF
    "선교 헌금"    →   key: "선교 헌금"                →   =SUMIF(K:K, "선교 헌금", G:G)
```

- OpenClaw가 `rules.json` 기반으로 K열 자동 태깅
- 태깅률 = 예산 추적 정확도
- 현재 K열 키 36개 등록

---

## 기존 예산안 (25.7~26.6) 분석 결과

### 발견된 수식 버그
- `C13`: `가계부 내역22` 참조 → `가계부 내역`이어야 함
- `M20`: `SUMIF(J열)` → `SUMIF(K열)`이어야 함 (메모가 아닌 상세 기준)
- `B19`: 수식 누락

### 기존 구조 문제점
- 4블록 매트릭스 레이아웃 (A:E, F:J, K:O, P:T) → 확장/수정 어려움
- 저축/투자가 지출 예산에 혼재 → 소비 예산 왜곡
- 비정기 대형 지출 무방비
- 수입(62M) < 예산(77M) → 자산 갈아먹는 구조

### 개선 적용
- 세로형 리스트 레이아웃으로 변경
- 5층 목적 우선순위 구조
- Config-driven 방식으로 구조 유연성 확보
- 실적 기반 예산 금액 재설계 (58M/년, 수입 내)

---

## 개발 로드맵

| Phase | 내용 | 상태 |
|-------|------|------|
| P1 | OpenClaw 자동 분류 파이프라인 | ✅ 완료 (크론잡) |
| P2 | 기존 예산 구조 분석 | ✅ 완료 |
| P3 | 청지기 5층 철학 설계 | ✅ 완료 |
| P4 | Config-driven 예산 시트 생성 | ✅ 완료 |
| P5 | LLM 기반 예산 수정 (`예산` 키워드) | ✅ 완료 (CLAUDE.md) |
| **P6** | **예산 기간 1~12월 전환 + 가계부 구조 개편** | **🔲 다음 작업** |
| **P7** | **모니터링 대시보드 강화** | **🔲 다음 작업** |
| P8 | 월간 리포트 자동 생성 | 🔲 미착수 |
| P9 | 대시보드 알림 (초과/부족) | 🔲 미착수 |
| P10 | 연간 리뷰 및 차기 예산 자동 초안 | 🔲 미착수 |

---

## 다음 작업 상세 (P6, P7)

### P6: 예산 기간 1~12월 전환 + 가계부 구조 개편

#### 배경
- 현재 예산 기간: 7월~익년 6월 (애매한 회계연도)
- 자연스러운 1월~12월 기준으로 전환 필요

#### 가계부 시트 구조: 단일 시트 유지 (권장)

| 방식 | 장점 | 단점 |
|------|------|------|
| **A. 단일 시트 + 날짜 필터 수식** | 검색 용이, 파이프라인 단순, 크로스-연도 분석 가능 | 시트가 커질 수 있음 |
| B. 연도별 시트 분리 | 시트당 가벼움, 시각적 분리 | 파이프라인 복잡 (어느 시트에 쓸지), 크로스-연도 분석 어려움 |

**단일 시트 권장 이유:**
- 현재 17개월 3,567건 → 연 2,500건 수준. 10년 쌓아도 25,000건. Google Sheets 한계(1,000만 셀)와 비교하면 여유
- OpenClaw 파이프라인이 시트 이름을 판단할 필요 없음 (항상 "가계부 내역"에 쓰면 됨)
- 예산안 SUMIFS에서 날짜 범위만 조건 추가하면 해당 연도만 집계 가능

#### 필요한 변경

1. **budget_config.yaml**: `period`를 `"2026"` 식으로 단순화, `period_start/end`를 `"2026-01-01"` / `"2026-12-31"`로
2. **budget.py deploy**: SUMIF → SUMIFS 변경 (날짜 범위 조건 추가)
   ```
   현재: =SUMIF(K:K, "식비", G:G)                    ← 전체 기간 합산
   변경: =SUMIFS(G:G, K:K, "식비", A:A, ">="&시작일, A:A, "<="&종료일)  ← 해당 연도만
   ```
3. **대시보드 수식**: 경과 월수, 전월 월급 등도 연도 기준으로 조정
4. **연도 전환**: 매년 1월에 새 예산안 시트 `deploy`만 하면 됨 (가계부 시트는 그대로)

---

### P7: 모니터링 대시보드 강화

#### 현재 문제
- 예산안 시트가 숫자 테이블로만 존재
- "지금 식비를 얼마나 썼는지" 한눈에 안 보임
- 예산 수정 (`예산` 키워드)으로 이어지는 뷰어 역할을 해야 하므로 시각성 중요

#### 강화 방안

**A. 예산안 시트 자체 강화 (deploy 시 자동 적용)**

| 기능 | 구현 | 효과 |
|------|------|------|
| 소진율 열 추가 (J열) | `=F/E` (실적/연예산) | 퍼센트로 한눈에 파악 |
| 진행률 바 (K열) | `=REPT("█", MIN(소진율*20,20))` | 시각적 게이지 |
| 조건부 서식 | 소진율 70%↑ 노랑, 90%↑ 빨강, 100%↑ 진빨강 | 위험 항목 즉시 식별 |
| 월별 페이스 (L열) | `=소진율/(경과월/12)` | 1보다 크면 초과 페이스 |
| 층별 소진율 | 소계 행에 전체 소진율 표시 | 층 단위 건강도 파악 |

**B. 별도 대시보드 시트 (새 탭)**

| 구역 | 내용 |
|------|------|
| 상단 | 수입 vs 지출 총괄 (큰 숫자 + 소진율 바) |
| 5층 요약 | 층별 1줄 요약: 예산/실적/소진율/상태 이모지 |
| 위험 항목 TOP 5 | 소진율 높은 항목 자동 정렬 |
| 월별 추이 | 최근 6개월 지출 추이 (SPARKLINE) |
| K열 태깅률 | 미분류 거래 비율 → 데이터 품질 지표 |
| 프로젝트 목표 | 각 프로젝트 goal 텍스트 + 달성 상태 |

**C. 알림 연동 (P9와 연결)**
- 월말에 자동으로 리포트 생성 → 초과 항목 리스트
- 소진율 100% 초과 항목 감지 → 알림

#### 대시보드 → 예산 수정 흐름

```
대시보드에서 "식비 소진율 120%" 확인
  → Claude Code 열기
  → "예산 — 식비가 초과됐는데 분석해줘"
  → 월별 추이 확인 + 원인 분석
  → "예산 — 식비 90만원으로 올려" 또는 "다른 항목에서 조정해줘"
  → validate → deploy
```

---

## 참고 문서

- [철학 & 5층 구조](steward_finance_philosophy.md)
- [시스템 아키텍처 다이어그램](steward_finance_architecture.drawio) (3페이지)
- [스프레드시트 구조 분석](spreadsheet_structure.md)
- [실적 기반 예산안 제안](new_budget_proposal.md)
- [CLAUDE.md](../CLAUDE.md) — Claude Code 컨텍스트 (예산 키워드 포함)
